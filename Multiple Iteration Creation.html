<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- Copyright (c) 2010  Rally Software Development Corp.  All rights reserved -->
<html>
    <head>
        <title>Iteration Copy</title>
        <meta name="Name" content="Iteration Copy" />
        <meta name="Version" content="1.1" />
        <meta name="Vendor" content="Rally Software" />
        <meta name="Author" content="Joel Krooswyk" />
        <script type="text/javascript" src="/apps/2.0p5/sdk.js?wsapiVersion=1.43"></script>

        <script type="text/javascript">
        Rally.onReady(function() {

                    var lastthree = 0;
                    var acceptedCount = 0;
                    var acceptedStories = new Array();
                    var avg = 0;

            Ext.define('CustomApp', {
                extend: 'Rally.app.App',
                componentCls: 'app',
                
               title: 'Iteration Copy Panel',
               layout: {
                    type: 'vbox',
                    align: 'center'
               },
               //renderTo: document.body,
               items: [
                    {
                        xtype: 'panel',
                        itemId: 'filters',
                        title: 'Multiple Iteration Creator',
                        titleAlign: 'center',
                        flex: 1,
                        border: 0,
                        margin: 4
                    },
                    {
                        xtype: 'container',
                        itemId: 'buttons'                        
                    }
                ],
                listeners: {
                    onavgCalc: function(avg) {
                        console.log("fired, avg = " + avg);
                        this._renderScreen(avg);
                    }
                },

                //set up UI
                launch: function() {
                    
                    //create event
                    this.addEvents('onavgCalc');
                    this._startStores();
                },

                _startStores: function() {
                                                                                                                                     
                    // get the velocity average from the last 3 iterations
                                        
                    var iterationStore = Ext.create('Rally.data.WsapiDataStore', {
                        model: 'Iteration',
                        autoLoad: true,
                        filters: [
                            {
                                property: 'EndDate',
                                operator: '<',
                                value: 'today'
                            }
                        ],
                        sorters: [
                            {
                                property: 'EndDate',
                                direction: 'DESC'
                            }
                        ],
                        listeners: {
                            load: function(store, data, success) {
                              //process data
                              this._processiterations(data);   
                            },
                            scope: this
                        },
                        scope: this
                    });
                },
                                   
                _processiterations: function(myData) { 
                    Ext.Array.each(myData, function(record) {
                            var iterationName = record.get('Name');
                            console.log(this);
                            if (lastthree < 3) {
                              Ext.create('Rally.data.WsapiDataStore', {
                                model: 'User Story',
                                autoLoad: true,
                                filters: [
                                    {
                                        property: 'Iteration.Name',
                                        operator: '=',
                                        value: iterationName
                                    }
                                ],
                                listeners: {
                                    load: function(store, data, success) {
                                        acceptedCount = 0;
                                        Ext.Array.each(data, function(record, avg, acceptedStories) {
                                            acceptedCount += record.get('PlanEstimate');
                                        }, this);
                                        acceptedStories.push(acceptedCount);
                                        console.log("acceptedstoriesarray = " + acceptedStories);
                                        avg = ((acceptedStories[0] + acceptedStories[1] + acceptedStories[2])/3);
                                        avg = avg.toFixed();
                                        console.log("avg inside = " + avg);
                                       
                                        if (acceptedStories.length === 3) {
                                            // HOW DO WE GET THIS IN SCOPE HERE?
                                            // Need  to name the stores, then callback when populated to launch event
                                            this.fireEvent('onavgCalc', avg);
                                            console.log("fired!");
                                        }
                                    },
                                    scope: this
                                },
                                scope: this
                              });
                            lastthree++;
                            }   
                        }, this);
                },

                _renderScreen: function(avg) { 
                                                            
                    // date box for new iteration start date
                    this.down('#filters').add({
                        xtype: 'rallydatefield',
                        itemId: 'dateFilter',
                        fieldLabel: '<B>New Iteration Start</B>',
                        value: new Date()
                    });
                    
                    // set iteration length
                    this.down('#filters').add({
                        xtype: 'rallynumberfield',
                        itemId: 'iterationLength',
                        fieldLabel: '<B>Length</B> <I>(Days)</I>',
                        value: 14,
                        maxValue: 185,
                        minValue: 7
                    });
                    
                    // planned velocity entry
                    this.down('#filters').add({
                        xtype: 'rallynumberfield',
                        itemId: 'iterationVelocity',
                        fieldLabel: '<B>Planned Velocity</B> <I>(Points)</I>',
                        value: avg,
                        maxValue: 500,
                        minValue: 1
                    });
                    
                    // iteration name base textbox (such as Sprint in "Sprint 5")
                    this.down('#filters').add({
                        xtype: 'rallytextfield',
                        itemId: 'iterationText',
                        fieldLabel: '<B>Iteration Name</B> <I>(such as "Sprint")</I>',
                        value: 'Sprint'
                    });
                    
                    //iteration number (such as the 5 of "Sprint 5")
                    this.down('#filters').add({
                        xtype: 'rallynumberfield',
                        itemId: 'iterationNumber',
                        fieldLabel: '<B>Starting Iteration Number</B> <I>(Sprint X)</I>',
                        value: 2,
                        maxValue: 999,
                        minValue: 0
                    });
                    
                    // number box for how many new iterations to create
                    this.down('#filters').add({
                        xtype: 'rallynumberfield',
                        itemId: 'numberField',
                        fieldLabel: '<B>Create This Many Iterations<B>',
                        value: 2,
                        increment: 1,
                        maxValue: 26,
                        minValue: 1
                    });
                    
                    // Copy start button
                    this.down('#buttons').add({
                        xtype: 'rallybutton',
                        text: 'Click to Create',
                        scope: this,
                        handler: function() {
                            this._GoforCreate();
                        }
                    });
                     
                  },
                    
                                    
                //extract values and create copies
                _GoforCreate: function() {
                    that = this;
                    
                    // get UI content snapshot
                    var IT = this.down('#iterationLength').getRawValue();
                    var IV = this.down('#iterationVelocity').getRawValue();
                    var DA = this.down('#dateFilter').getRawValue();
                    var NF = this.down('#numberField').getRawValue();
                    var IN = this.down('#iterationText').getRawValue();
                    var INUM = this.down('#iterationNumber').getRawValue();
                    var INUMS = parseInt(INUM)
                    var ItName = IN + " " + INUM;
                    //console.log(IT);
                    //console.log(IV);
                    //console.log(DA);
                    //console.log(NF);
                    //console.log(ItName);
                    
                    // Create Iteration Data for each Iteration to be created
                    Rally.data.ModelFactory.getModel({
                         type: 'Iteration',
                         success: function (itermodel) {
                            var counter = 0;
                            var Array1 = new Array();
                            Array1 = Ext.Array.pluck(itermodel.getFields(), 'name');
                            //Array1 = itermodel.getFields();
                            console.log(Array1);
                            while (counter < NF) {
                        
                                // calculate start date
                                var ObjID = "0"
                                if (counter == 0) {
                                    var NewDA = new Date(DA);
                                } else {
                                    var NewDA = new Date(DA); 
                                    NewDA.setDate(NewDA.getDate() + (counter * parseInt(IT)));
                                };
                                
                                //format to ISO manually
                                NewStartDA = ISODateString(NewDA);
                                NewStartDA = NewStartDA.substr(0,10);
                                console.log("NewStartDA = " + NewStartDA + " type = " + typeof(NewStartDA));
                        
                                // calculate end date
                                NewDA.setDate(NewDA.getDate() + parseInt(IT));
                                
                                //format to ISO manually
                                NewEndDA = ISODateString(NewDA);
                                NewEndDA = NewEndDA.substr(0,10);
                                console.log("NewEndDA = " + NewEndDA);
                        
                                // update iteration name
                                var ItName = IN + " " + INUMS;
                                //console.log(ItName);
                                //console.log(counter);
                       
                                var iterrecord = Ext.create(itermodel, {
                                    Name: ItName,
                                    State: 'Planning',
                                    StartDate: NewStartDA,
                                    EndDate: NewEndDA,
                                    Resources: IV
                                });
                                iterrecord.save({
                                    callback: function(result, operation) {
                                        console.log(operation);
                                        if (operation.wasSuccessful()) {
                                            var objectId = result.get('ObjectID');
                                            console.log("New iteration ID = " + objectId);
                                        }
                                    }
                                });
                                
                                counter++;
                                INUMS++
                                
                           }
                        }
                    });
                
                    // tell user iterations were created
                    Ext.MessageBox.alert('Finished!', (NF + ' Iterations were created.'));
                    
                    function ISODateString(d){
                    function pad(n){return n<10 ? '0'+n : n}
                        return d.getUTCFullYear()+'-'+ pad(d.getUTCMonth()+1)+'-'+ pad(d.getUTCDate())+'T'+ pad(d.getUTCHours())+':'+ pad(d.getUTCMinutes())+':'+ pad(d.getUTCSeconds())+'Z'}

                }
                
            });
            
            Rally.launchApp('CustomApp', {
                name: 'Multiple Iteration Creation'
            });
        });
    </script>

    <style type="text/css">
    </style>
</head>
<body></body>
</html>
